<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å„€å¼æ™‚é–“è¦åŠƒå™¨ - æœ€çµ‚ç‰ˆ (RWD)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
      /* ----------------------------------------------------
         1. RWD åŸºç¤è¨­å®š (æ‰‹æ©Ÿå„ªå…ˆ)
         ---------------------------------------------------- */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
        font-size: 14px;
        line-height: 1.5;
        overflow-x: hidden;
      }

      .container {
        width: 100%;
        max-width: 768px;
        margin: 0 auto;
        padding: 10px;
        box-sizing: border-box;
      }

      h2 {
        color: #333;
        text-align: center;
        margin-top: 10px;
        margin-bottom: 15px;
        font-size: 1.5em;
      }

      /* æ¡ˆåè¼¸å…¥æ¡†æ¨£å¼ */
      #case-name-input {
        box-sizing: border-box;
        width: 100%;
        padding: 8px 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1.1em;
        font-weight: bold;
        text-align: center;
      }

      /* ----------------------------------------------------
         2. è¡¨æ ¼å’Œå–®å…ƒæ ¼æ¨£å¼ (åš´æ ¼å›ºå®š 40:30:30 æ¯”ä¾‹)
         ---------------------------------------------------- */

      table {
        width: 100%;
        margin: 10px 0;
        border-collapse: collapse;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: #fff;
        table-layout: fixed; /* ç¢ºä¿å¯¬åº¦æ¯”ä¾‹å›ºå®šæœ‰æ•ˆ */
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 8px 3px; /* æ‰‹æ©Ÿä¸Šï¼šç¸®å°å…§é‚Šè·ä»¥å®¹ç´æ™‚é–“è¼¸å…¥æ¡† */
        text-align: center;
        vertical-align: middle;
      }

      th {
        background-color: #4caf50;
        color: white;
        font-size: 0.9em;
      }

      /* æ¬„ä½å¯¬åº¦åš´æ ¼å›ºå®šæ¯”ä¾‹ 40:30:30 (é©ç”¨æ–¼æ‰€æœ‰å¯¬åº¦) */
      #ceremony-table th:nth-child(1),
      #ceremony-table td:nth-child(1) {
        width: 40%;
      }
      #ceremony-table th:nth-child(2),
      #ceremony-table td:nth-child(2) {
        width: 30%;
      }
      #ceremony-table th:nth-child(3),
      #ceremony-table td:nth-child(3) {
        width: 30%;
      }

      /* ----------------------------------------------------
         3. è¼¸å…¥æ¡†åŠç§»é™¤æŒ‰éˆ•çš„ RWD çµ±ä¸€é…ç½®
         ---------------------------------------------------- */

      input[type="number"],
      .ceremony-name-input {
        box-sizing: border-box;
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        font-size: 14px;
        margin: 0;
      }

      /* è¡¨å®šæ™‚é–“è¼¸å…¥æ¡†ï¼šåš´æ ¼è¦æ±‚å®Œæ•´é¡¯ç¤º */
      input[type="time"] {
        box-sizing: border-box;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        margin: 0;
        width: 100%;
        min-width: 95px;
      }

      /* åœ¨æ¥µçª„ç’°å¢ƒä¸‹ï¼Œå¯èƒ½éœ€è¦é€²ä¸€æ­¥ç¸®å°å–®å…ƒæ ¼çš„å·¦å³å…§é‚Šè· */
      @media (max-width: 450px) {
        td:nth-child(2) {
          padding-left: 1px;
          padding-right: 1px;
        }
      }

      .ceremony-name-wrapper {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 0;
      }

      /* ç§»é™¤æŒ‰éˆ•çµ±ä¸€è¦–è¦ºæ•ˆæœ (é è¨­æ·ºç°/Hoverç´…è‰²) */
      .remove-btn-rwd {
        background: none;
        border: none;
        color: #ccc;
        font-size: 1.3em;
        cursor: pointer;
        padding: 0 5px;
        line-height: 1;
        display: inline;
        margin-right: 5px;
        flex-shrink: 0;
        transition: color 0.2s;
      }

      .remove-btn-rwd:hover,
      .remove-btn-rwd:active {
        color: #f44336;
      }

      .ceremony-name-input {
        text-align: left;
        padding-left: 5px;
        font-weight: normal;
        color: #333;
        border: none;
        background-color: transparent;
        flex-grow: 1;
        min-width: 50px;
      }

      .output-field {
        background-color: #f0f8ff;
        border: 1px solid #b0c4de;
        color: #333 !important;
      }

      /* ----------------------------------------------------
         4. æŒ‰éˆ•æ¨£å¼ (æ–°å¢æµç¨‹æŒ‰éˆ•)
         ---------------------------------------------------- */

      .add-btn {
        width: 100%;
        margin: 0;
        padding: 8px;
        background-color: #4caf50;
        color: white;
        border: 1px solid #4caf50;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      button.add-btn:first-of-type {
        margin-bottom: 10px;
      }
      button.add-btn:last-of-type {
        margin-top: 10px;
      }

      .add-btn:hover {
        background-color: #45a049;
      }

      /* ----------------------------------------------------
         5. æ§åˆ¶æŒ‰éˆ•ç¾¤çµ„åŠå½ˆå‡ºè¦–çª—æ¨£å¼ 
         ---------------------------------------------------- */
      .button-group {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .control-btn {
        flex-grow: 1;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 15px;
        font-weight: bold;
      }

      .reset-btn {
        background-color: #007bff;
        color: white;
      }
      .reset-btn:hover {
        background-color: #0056b3;
      }
      .output-btn {
        background-color: #4caf50;
        color: white;
      }
      .output-btn:hover {
        background-color: #45a049;
      }

      .output-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-height: 80%;
        overflow-y: auto;
        text-align: center; /* è®“åœ–ç‰‡å±…ä¸­ */
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        text-align: left;
      }

      .close-btn {
        font-size: 2em;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: none;
        line-height: 1;
      }

      /* è¼¸å‡ºæ™‚ä½¿ç”¨çš„éš±è—è¡¨æ ¼çµæ§‹ï¼Œç”¨æ–¼ç”Ÿæˆåœ–ç‰‡ */
      #image-capture-wrapper {
        width: 100%;
        max-width: 600px; /* é™åˆ¶åœ–ç‰‡å¯¬åº¦ä»¥é©æ‡‰å¸¸è¦‹åœ–ç‰‡å°ºå¯¸ */
        margin: 0 auto;
        background-color: white;
        padding: 10px;
      }
      #outputHtmlTable th,
      #outputHtmlTable td {
        border: 1px solid #333; /* åœ–ç‰‡é‚Šæ¡†ä½¿ç”¨æ·±è‰²ï¼Œç¢ºä¿æ¸…æ™° */
        padding: 12px 10px;
        text-align: center;
        font-size: 16px;
        font-family: "Arial", sans-serif;
      }
      #outputHtmlTable th {
        background-color: #4caf50;
        color: white;
      }
      #outputHtmlTable tr:nth-child(even) {
        background-color: #f0f0f0;
      }
      #outputHtmlTable tr:nth-child(odd) {
        background-color: #fff;
      }

      /* ----------------------------------------------------
         6. Media Queries - å¹³æ¿åŠæ¡Œé¢ (min-width: 768px)
         ---------------------------------------------------- */
      @media (min-width: 768px) {
        .container {
          padding: 20px 20px;
        }

        th,
        td {
          padding: 12px 5px;
          font-size: 16px;
        }

        /* æ¡Œé¢æ¨¡å¼ï¼šä¿æŒæ™‚é–“è¼¸å…¥æ¡†çš„éŸ¿æ‡‰æ€§å’Œæœ€å°å¯¬åº¦ */
        input[type="time"] {
          width: 100%;
          min-width: 110px;
          font-size: 16px;
        }

        input[type="number"] {
          width: 100%;
          font-size: 16px;
        }

        .ceremony-name-input {
          text-align: left;
          font-weight: bold;
          border: none;
          background-color: transparent;
          padding: 3px 5px;
          flex-grow: 1;
        }

        .remove-btn-rwd {
          font-size: 1.5em;
          color: #ccc;
        }

        .ceremony-name-wrapper:hover .remove-btn-rwd {
          color: #f44336;
        }

        .button-group {
          max-width: 768px;
          margin: 20px auto;
        }
      }
    </style>
  </head>

  <body>
    <div id="outputModal" class="output-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="output-modal-title">ğŸ“‹ è¡Œç¨‹è¡¨ PNG è¼¸å‡º</h3>
          <button
            class="close-btn"
            onclick="document.getElementById('outputModal').style.display='none'"
          >
            Ã—
          </button>
        </div>

        <p>è«‹ç¢ºèªä»¥ä¸‹åœ–ç‰‡é è¦½ï¼Œç„¶å¾Œé»æ“Šä¸‹è¼‰æŒ‰éˆ•ï¼š</p>

        <div
          id="outputImageContainer"
          style="margin: 15px auto; border: 1px solid #ddd; max-width: 100%"
        ></div>

        <p style="font-size: 0.9em; color: #555; margin-top: 10px">
          (åœ–ç‰‡å°‡ä»¥ PNG æ ¼å¼ä¸‹è¼‰ï¼Œå»ºè­°æ‚¨æª¢æŸ¥ä¸‹è¼‰è³‡æ–™å¤¾)
        </p>

        <button class="control-btn output-btn" id="download-btn">
          ä¸‹è¼‰ PNG åœ–ç‰‡
        </button>
      </div>
    </div>

    <div class="container">
      <h2>å‡ºæ®¯æµç¨‹æ™‚é–“æ¼”ç®—</h2>

      <input
        type="text"
        id="case-name-input"
        placeholder="è«‹è¼¸å…¥æ¡ˆå (ä¾‹å¦‚ï¼šæåºœå‘Šåˆ¥å¼)"
        value=""
        title="æ¡ˆå"
      />

      <button class="add-btn" onclick="addCeremony('top')">â–²æ–°å¢æµç¨‹</button>

      <table id="ceremony-table">
        <thead>
          <tr>
            <th>å„€å¼</th>
            <th class="time-cell">è¡¨å®šæ™‚é–“</th>
            <th>è¦åŠƒæ™‚é–“ (åˆ†)</th>
          </tr>
        </thead>

        <tbody id="ceremony-tbody"></tbody>
      </table>

      <button class="add-btn" onclick="addCeremony('bottom')">â–¼æ–°å¢æµç¨‹</button>

      <div class="button-group">
        <button class="control-btn output-btn" onclick="outputSchedule()">
          è¼¸å‡º PNG æµç¨‹åœ–
        </button>
        <button class="control-btn reset-btn" onclick="resetPlanner()">
          é‡æ–°è¦åŠƒ
        </button>
      </div>

      <div id="image-capture-wrapper" style="position: absolute; left: -9999px">
        <div
          id="capture-header"
          style="
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border: 1px solid #333;
            background-color: #f0f0f0;
          "
        ></div>
        <table id="capture-table"></table>
      </div>
    </div>

    <script>
      let anchorId = "A";
      let ceremonyCounter = 1;
      const DEFAULT_ANCHOR_ID = "A";
      let draggedRow = null;

      // è¼”åŠ©å‡½æ•¸ (ä¿æŒä¸è®Š)
      function timeToMinutes(timeStr) {
        if (!timeStr || timeStr.length !== 5) return null;
        const [hours, minutes] = timeStr.split(":").map(Number);
        if (hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
          return hours * 60 + minutes;
        }
        return null;
      }
      function minutesToTime(totalMinutes) {
        const MINUTES_IN_DAY = 24 * 60;
        const safeMinutes =
          ((totalMinutes % MINUTES_IN_DAY) + MINUTES_IN_DAY) % MINUTES_IN_DAY;
        const hours = Math.floor(safeMinutes / 60);
        const minutes = safeMinutes % 60;
        const hourStr = String(hours).padStart(2, "0");
        const minuteStr = String(minutes).padStart(2, "0");
        return `${hourStr}:${minuteStr}`;
      }
      function getCeremonyIds() {
        const rows = document
          .getElementById("ceremony-tbody")
          .querySelectorAll("tr");
        const ids = Array.from(rows).map((row) => row.getAttribute("data-id"));
        return ids;
      }

      /**
       * æ ¸å¿ƒè¨ˆç®—é‚è¼¯ (ä¿æŒä¸è®Š)
       */
      function calculateTimes(triggeredId) {
        const CEREMONY_IDS = getCeremonyIds();

        if (triggeredId && triggeredId.startsWith("start-time-")) {
          const currentAnchor = triggeredId.replace("start-time-", "");
          const timeValue = document.getElementById(triggeredId).value;
          if (timeToMinutes(timeValue) !== null) {
            anchorId = currentAnchor;
          }
        }

        let effectiveAnchorId = anchorId;
        let anchorTimeElement = document.getElementById(
          `start-time-${effectiveAnchorId}`
        );
        let anchorTime_min = timeToMinutes(
          anchorTimeElement ? anchorTimeElement.value : null
        );

        if (anchorTime_min === null || !anchorTimeElement) {
          effectiveAnchorId = null;
          for (const id of CEREMONY_IDS) {
            const timeInput = document.getElementById(`start-time-${id}`);
            if (timeToMinutes(timeInput ? timeInput.value : null) !== null) {
              effectiveAnchorId = id;
              anchorTime_min = timeToMinutes(timeInput.value);
              break;
            }
          }
        }

        if (anchorTime_min === null || effectiveAnchorId === null) {
          anchorId = DEFAULT_ANCHOR_ID;
          CEREMONY_IDS.forEach((id) => {
            const timeInput = document.getElementById(`start-time-${id}`);
            if (timeInput) {
              timeInput.classList.remove("output-field");
              timeInput.title = "";
            }
          });
          return;
        }

        anchorId = effectiveAnchorId;

        const durations = {};
        CEREMONY_IDS.forEach((id) => {
          const durationInput = document.getElementById(`duration-${id}`);
          durations[id] = Number(durationInput ? durationInput.value : 0) || 0;
        });

        const calculatedMinutes = {};
        calculatedMinutes[anchorId] = anchorTime_min;
        const anchorIndex = CEREMONY_IDS.indexOf(anchorId);

        let currentMin = anchorTime_min;
        for (let i = anchorIndex; i > 0; i--) {
          const prevId = CEREMONY_IDS[i - 1];
          const prevDuration = durations[prevId];
          currentMin -= prevDuration;
          calculatedMinutes[prevId] = currentMin;
        }

        currentMin = anchorTime_min;
        for (let i = anchorIndex; i < CEREMONY_IDS.length - 1; i++) {
          const currentId = CEREMONY_IDS[i];
          const currentDuration = durations[currentId];
          currentMin += currentDuration;
          const nextId = CEREMONY_IDS[i + 1];
          calculatedMinutes[nextId] = currentMin;
        }

        CEREMONY_IDS.forEach((id) => {
          const timeInput = document.getElementById(`start-time-${id}`);
          const calculatedMin = calculatedMinutes[id];

          if (timeInput) {
            if (id !== anchorId) {
              timeInput.value = minutesToTime(calculatedMin);
              timeInput.classList.add("output-field");
              const currentAnchorElement = document.getElementById(
                `start-time-${anchorId}`
              );
              const anchorTime = currentAnchorElement
                ? currentAnchorElement.value
                : "æœªçŸ¥æ™‚é–“";
              timeInput.title = `ç”± ${anchorId} (${anchorTime}) æ¨ç®—è€Œä¾†`;
            } else {
              timeInput.classList.remove("output-field");
              timeInput.title = "æ‰‹å‹•è¨­å®šçš„èµ·å§‹æ™‚é–“";
            }
          }
        });
      }

      /**
       * å»ºç«‹ä¸€å€‹æ–°çš„è¡¨æ ¼è¡Œ (<tr>) çš„ HTML çµæ§‹ (ä¿æŒä¸è®Š)
       */
      function createNewCeremonyRow(id, name, duration = 0, startTime = "") {
        const removeButtonRWD = `<button class="remove-btn-rwd" onclick="removeCeremony('${id}')" title="ç§»é™¤æµç¨‹">âœ–</button>`;

        return `
          <tr data-id="${id}" draggable="true">
            <td>
              <div class="ceremony-name-wrapper">
                ${removeButtonRWD} 
                <input type="text" class="ceremony-name-input" value="${name}" oninput="this.title=this.value">
              </div>
            </td>
            <td class="time-cell">
              <input type="time" id="start-time-${id}" oninput="calculateTimes(this.id)" value="${startTime}">
            </td>
            <td><input type="number" id="duration-${id}" min="0" value="${duration}" oninput="calculateTimes()"></td>
          </tr>
        `;
      }

      // ... (addCeremony, removeCeremony, resetPlanner å‡½æ•¸ä¿æŒä¸è®Š)
      function addCeremony(position) {
        const tbody = document.getElementById("ceremony-tbody");
        const newId = `CUST${ceremonyCounter++}`;
        const newName = `æ–°æµç¨‹ ${ceremonyCounter - 1}`;
        const newRowHtml = createNewCeremonyRow(newId, newName, 0, "");

        if (position === "top") {
          tbody.insertAdjacentHTML("afterbegin", newRowHtml);
        } else {
          tbody.insertAdjacentHTML("beforeend", newRowHtml);
        }

        calculateTimes();
        setupDragAndDrop();
      }
      function removeCeremony(id) {
        const rowToRemove = document.querySelector(`tr[data-id="${id}"]`);

        if (rowToRemove) {
          rowToRemove.remove();

          if (anchorId === id) {
            let newAnchorId = null;
            const CEREMONY_IDS = getCeremonyIds();
            for (const nextId of CEREMONY_IDS) {
              const timeInput = document.getElementById(`start-time-${nextId}`);
              if (timeInput && timeToMinutes(timeInput.value) !== null) {
                newAnchorId = nextId;
                break;
              }
            }
            anchorId = newAnchorId !== null ? newAnchorId : DEFAULT_ANCHOR_ID;
          }

          calculateTimes();
        }
      }
      function resetPlanner() {
        const defaultRowsData = [
          { id: "A", name: "é›†åˆ", t: "07:30", n: 30 },
          { id: "B", name: "å…¥æ®®", t: "08:00", n: 45 },
          { id: "C", name: "é»ä¸»", t: "08:45", n: 5 },
          { id: "D", name: "å®¶å¥ ", t: "08:50", n: 40 },
          { id: "E", name: "å…¬å¥ ", t: "09:30", n: 30 },
          { id: "F", name: "æ‹ˆé¦™", t: "10:00", n: 30 },
          { id: "G", name: "ç™¼å¼•", t: "10:30", n: 15 },
          { id: "H", name: "ç«åŒ–", t: "10:45", n: 150 },
        ];

        const tbody = document.getElementById("ceremony-tbody");
        tbody.innerHTML = "";
        ceremonyCounter = 1;
        anchorId = DEFAULT_ANCHOR_ID;
        // æ¸…é™¤æ¡ˆå
        document.getElementById("case-name-input").value = "";

        defaultRowsData.forEach((row) => {
          const rowHtml = createNewCeremonyRow(row.id, row.name, row.n, row.t);
          tbody.insertAdjacentHTML("beforeend", rowHtml);
        });

        setupDragAndDrop();
        calculateTimes();
      }

      /* =======================================================
         è¼¸å‡º PNG æµç¨‹åœ– (å·²é‡å¯«)
         ======================================================= */
      function createCaptureTableHTML() {
        const tbody = document.getElementById("ceremony-tbody");
        const rows = tbody.querySelectorAll("tr");

        let tableBodyHtml = "<tbody>";

        rows.forEach((row, index) => {
          const id = row.getAttribute("data-id");
          const timeInput = document.getElementById(`start-time-${id}`);
          const nameInput = row.querySelector(".ceremony-name-input");
          const durationInput = document.getElementById(`duration-${id}`);

          const time = timeInput ? timeInput.value || "" : "";
          const name = nameInput ? nameInput.value || "" : "";
          const duration = durationInput ? durationInput.value || "0" : "0";

          const rowClass = index % 2 === 0 ? "even" : "odd";

          // æ³¨æ„: é€™è£¡ä½¿ç”¨å…§è¯æ¨£å¼ä¾†ç¢ºä¿åœ–ç‰‡æ¸²æŸ“æ™‚èƒ½æ•æ‰åˆ°é¡è‰²å’Œé‚Šç•Œ
          const rowStyle =
            index % 2 === 0
              ? "background-color: #fff;"
              : "background-color: #f0f0f0;";

          tableBodyHtml += `<tr style="${rowStyle}">`;
          tableBodyHtml += `<td style="width: 40%; border: 1px solid #333; padding: 12px 10px; text-align: left; font-weight: bold;">${name}</td>`;
          tableBodyHtml += `<td style="width: 30%; border: 1px solid #333; padding: 12px 10px; text-align: center; color: #333;">${time}</td>`;
          tableBodyHtml += `<td style="width: 30%; border: 1px solid #333; padding: 12px 10px; text-align: center;">${duration}</td>`;
          tableBodyHtml += "</tr>";
        });

        tableBodyHtml += "</tbody>";
        return tableBodyHtml;
      }

      async function outputSchedule() {
        const caseNameInput = document.getElementById("case-name-input");
        const caseName = caseNameInput.value.trim() || "æœªå‘½åæ¡ˆå";
        const finalFileName = `${caseName}_å‡ºæ®¯æµç¨‹.png`;

        // 1. æº–å‚™ç”¨æ–¼æ•æ‰çš„ HTML çµæ§‹ (ç¢ºä¿æ¨£å¼è¢«å…§åµŒæˆ–å¼•ç”¨)
        const captureWrapper = document.getElementById("image-capture-wrapper");
        const captureHeader = document.getElementById("capture-header");
        const captureTable = document.getElementById("capture-table");

        captureHeader.textContent = `${caseName} - å‡ºæ®¯æµç¨‹æ™‚é–“è¡¨`;

        // è¤‡è£½ä¸»è¡¨æ ¼çš„ Header
        const mainTableHeader = document
          .getElementById("ceremony-table")
          .querySelector("thead").innerHTML;

        captureTable.innerHTML = `
              <thead>
                <tr>
                    <th style="width: 40%; background-color: #4caf50; color: white;">å„€å¼</th>
                    <th style="width: 30%; background-color: #4caf50; color: white;">è¡¨å®šæ™‚é–“</th>
                    <th style="width: 30%; background-color: #4caf50; color: white;">è¦åŠƒæ™‚é•· (åˆ†)</th>
                </tr>
              </thead>
              ${createCaptureTableHTML()}
          `;

        // 2. ä½¿ç”¨ html2canvas æ•æ‰å…ƒç´ 
        document.getElementById(
          "output-modal-title"
        ).textContent = `${caseName} - PNG è¼¸å‡º`;
        document.getElementById("outputModal").style.display = "flex";

        // æ¸…ç©ºèˆŠåœ–ç‰‡
        const imageContainer = document.getElementById("outputImageContainer");
        imageContainer.innerHTML = "æ­£åœ¨ç”Ÿæˆåœ–ç‰‡...";

        try {
          const canvas = await html2canvas(captureWrapper, {
            scale: 2, // æé«˜è§£æåº¦
            backgroundColor: "#ffffff", // ç¢ºä¿èƒŒæ™¯ç‚ºç™½è‰²
            useCORS: true,
          });

          const dataURL = canvas.toDataURL("image/png");

          // 3. é¡¯ç¤ºåœ–ç‰‡é è¦½
          imageContainer.innerHTML = "";
          const img = document.createElement("img");
          img.src = dataURL;
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          imageContainer.appendChild(img);

          // 4. è¨­å®šä¸‹è¼‰æŒ‰éˆ•
          const downloadBtn = document.getElementById("download-btn");
          downloadBtn.onclick = function () {
            const a = document.createElement("a");
            a.href = dataURL;
            a.download = finalFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          };
        } catch (error) {
          imageContainer.innerHTML = "åœ–ç‰‡ç”Ÿæˆå¤±æ•—ã€‚";
          console.error("html2canvas éŒ¯èª¤:", error);
        }
      }

      // ç”±æ–¼æ”¹ç‚ºåœ–ç‰‡è¼¸å‡ºï¼Œæ­¤å‡½æ•¸ä¸å†ä½¿ç”¨ï¼Œä½†ä¿ç•™ä¸‹è¼‰é‚è¼¯çš„åƒè€ƒ
      function copyTableContent() {
        alert("åŠŸèƒ½å·²åˆ‡æ›è‡³ã€Œä¸‹è¼‰ PNG åœ–ç‰‡ã€");
      }

      /* =======================================================
         æ‹–æ›³æ’åºåŠŸèƒ½ (ä¿æŒä¸è®Š)
         ======================================================= */
      function handleDragStart(e) {
        if (
          e.target.tagName.toLowerCase() === "input" ||
          e.target.tagName.toLowerCase() === "button"
        ) {
          e.preventDefault();
          return;
        }

        draggedRow = this;
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", this.getAttribute("data-id"));
        this.classList.add("dragging");
      }
      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        const targetRow = this;
        if (draggedRow && draggedRow !== targetRow) {
          document.querySelectorAll("#ceremony-tbody tr").forEach((row) => {
            row.classList.remove("drag-over-top", "drag-over-bottom");
          });
          const rect = targetRow.getBoundingClientRect();
          const midPoint = rect.y + rect.height / 2;
          if (e.clientY < midPoint) {
            targetRow.classList.add("drag-over-top");
          } else {
            targetRow.classList.add("drag-over-bottom");
          }
        }
      }
      function handleDragLeave(e) {
        this.classList.remove("drag-over-top", "drag-over-bottom");
      }
      function handleDrop(e) {
        e.preventDefault();
        const targetRow = this;
        document.querySelectorAll("#ceremony-tbody tr").forEach((row) => {
          row.classList.remove("drag-over-top", "drag-over-bottom", "dragging");
        });
        if (draggedRow && draggedRow !== targetRow) {
          const tbody = document.getElementById("ceremony-tbody");
          const isBefore = targetRow.classList.contains("drag-over-top");
          if (isBefore) {
            tbody.insertBefore(draggedRow, targetRow);
          } else {
            tbody.insertBefore(draggedRow, targetRow.nextSibling);
          }
          calculateTimes();
        }
        draggedRow = null;
      }
      function handleDragEnd(e) {
        document.querySelectorAll("#ceremony-tbody tr").forEach((row) => {
          row.classList.remove("drag-over-top", "drag-over-bottom", "dragging");
        });
        draggedRow = null;
      }
      function setupDragAndDrop() {
        const rows = document.querySelectorAll("#ceremony-tbody tr");
        rows.forEach((row) => {
          row.removeEventListener("dragstart", handleDragStart);
          row.removeEventListener("dragover", handleDragOver);
          row.removeEventListener("dragleave", handleDragLeave);
          row.removeEventListener("drop", handleDrop);
          row.removeEventListener("dragend", handleDragEnd);

          row.addEventListener("dragstart", handleDragStart);
          row.addEventListener("dragover", handleDragOver);
          row.addEventListener("dragleave", handleDragLeave);
          row.addEventListener("drop", handleDrop);
          row.addEventListener("dragend", handleDragEnd);
        });
      }

      document.addEventListener("DOMContentLoaded", resetPlanner);
    </script>
  </body>
</html>
